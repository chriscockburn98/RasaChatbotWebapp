const axios = require('axios');
const Recorder = require('./Recorder')

function askRasa(req, username = "anon", query) {
  if(!query) return 
  return new Promise((resolve, reject) => {
    axios.post('http://localhost:5005/webhooks/rest/webhook', {
      "sender": username,
      "message": query
    })
    .then(async (response) => {
      if (!response.data || response.data.length == 0) return resolve({response: "Sorry I don't understand!"})

      const jsonObj = JSON.parse(response.data[0].text)
      console.log(jsonObj)
      let storedId = null;

      await Recorder.storeQueryAction(username, query, jsonObj.response_utter, req.device.type, "No feedback")
      .then(res => storedId = res)
      .catch(err => console.log(err))

      const jsonResponse = {
        id: storedId,
        response: jsonObj.response
      }
      
      if(jsonObj.location)
        jsonResponse['location'] = jsonObj.location

      return resolve(jsonResponse)
    })
    .catch((error) => {
      console.log(`ERROR  :: ${error}`);
      return resolve({response: "Sorry I don't understand!"})
    });
  })
}

module.exports = {
	askRasa,
}